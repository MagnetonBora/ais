\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{subook}[2014/03/28 State University (Soviet Union) Book]
\RequirePackage{fontspec}
%\RequirePackage[utf8]{inputenc}
\RequirePackage{amssymb,amsmath,amsfonts}
\RequirePackage{ntheorem}
\RequirePackage[paper=a4paper, twoside, includehead,left=2.5cm, right=2.5cm, top=1.7cm, bottom=2.5cm, centering, bindingoffset=0mm]{geometry}
%\RequirePackage[paper=a4paper, twoside, includehead,left=2.25cm, right=2.25cm, top=1.5cm, bottom=2.33cm, centering, bindingoffset=0mm]{geometry}
\RequirePackage{longtable}
\RequirePackage{fancyhdr}
%\RequirePackage{pstricks}
%\RequirePackage{pst-all}
%\RequirePackage{pst-poly}
\RequirePackage{indentfirst}
\RequirePackage{caption}
\RequirePackage{pageslts}
\RequirePackage{tocloft}
\RequirePackage{secdot}
\RequirePackage{cmap}
\RequirePackage{hyperref}
\RequirePackage[sort&compress]{natbib} % Adjusting \cite's
\RequirePackage{hypernat}

\defaultfontfeatures{Ligatures={TeX,Required}}
\newcommand\su@scale{1.0}
\newcommand\su@LARGE{\LARGE}
\newcommand\sutypeface{Computer Modern}
\newcommand\sufontfamily{\sutypeface}


\setcitestyle{numbers,square}
\def\isu@defgeom{\geometry{}}

\let\chapter@su@name=\chaptername
\DeclareOption{monograph}{
\setcitestyle{numbers,square,semicolon}
}
\DeclareOption{handbook}{
\setcitestyle{numbers,square,comma}
\renewcommand{\chapter@su@name}{}
}
\DeclareOption{fancytop}{
%\fancypagestyle{plain}{%
\fancyhf{} % clear all header and footer fields
%\fancyfoot[C]{\bfseries \thepage} % except the center
\fancyhead[RE]{\normalsize\it \nouppercase{\leftmark}}
\fancyhead[LO]{\normalsize\it \nouppercase{\rightmark}}
\fancyhead[RO,LE]{\normalsize \thepage}
%\renewcommand{\headrulewidth}{0pt}
\renewcommand{\headrulewidth}{1pt}
\renewcommand{\footrulewidth}{0pt}%}
\pagestyle{fancy}
}
\DeclareOption{fancybot}{
%\fancypagestyle{plain}{%
\fancyhf{} % clear all header and footer fields
%\fancyfoot[C]{\bfseries \thepage} % except the center
\fancyhead[LE]{\normalsize\it \nouppercase{\leftmark}}
\fancyhead[RO]{\normalsize\it \nouppercase{\rightmark}}
\fancyfoot[RO,LE]{\normalsize \thepage}
%\renewcommand{\headrulewidth}{0pt}
\renewcommand{\headrulewidth}{1pt}
\renewcommand{\footrulewidth}{0pt}%}
\pagestyle{fancy}
}
\DeclareOption{mag}{
%\mag 1200
%\def\isu@defgeom{\geometry{papersize={17.5cm,24.75cm}, left=2.25cm, right=2.25cm, top=1.5cm, bottom=2.33cm, centering, bindingoffset=1mm}}
\def\isu@defgeom{\geometry{}}
}
\DeclareOption{14pt}{
\renewcommand\su@scale{1.1667}
\renewcommand\baselinestretch{1.3} % WORKAROUND
}

\DeclareOption{times}{
%\renewcommand{\rmdefault}{ftm}
\setmainfont[Scale=\su@scale]{Times New Roman}
\setmonofont[Ligatures=TeX,Scale=MatchLowercase,Numbers=SlashedZero]{Courier New}
\setsansfont{Calibri}
\renewcommand\sutypeface{Таймс}
}

\DeclareOption{freetimes}{
%\renewcommand{\rmdefault}{ftm}
\setmainfont[Scale=\su@scale]{Free Times}
\setmonofont[Ligatures=TeX,Scale=MatchLowercase,Numbers=SlashedZero]{Free Courier}
\setsansfont{Calibri}
\renewcommand\sutypeface{Таймс}
}

\DeclareOption{lit}{
\setmainfont[
Path="./subook/",
BoldFont=quantantiquabold.ttf,
ItalicFont=quantantiquaitalic.ttf,
BoldItalicFont=quantantiquabolditalic.ttf,
]{quantantiquaplain.ttf}
\renewcommand\sutypeface{Литературная}
}
\DeclareOption{listbib}{
\renewcommand{\@biblabel}[1]{#1.}
}
\DeclareOption{firamono}{
\setmonofont[Ligatures=TeX,Scale=MatchLowercase,Numbers=SlashedZero]{Fira Mono OT}
}
\DeclareOption{firasans}{
\setsansfont[Ligatures=TeX,Scale=MatchLowercase]{Fira Sans OT}
}
\DeclareOption{inconsolata}{
\setmonofont[Ligatures=TeX,Scale=MatchLowercase,Numbers=SlashedZero]{Inconsolata LGC}
}

\DeclareOption{smalltitles}{
\renewcommand\section{\@startsection {section}{1}{\z@}%
                                   {-3.25ex \@plus -1ex \@minus -.2ex}%
                                   {1.8ex \@plus.2ex}%
                                   {\normalfont\large\bfseries}}
\renewcommand\subsection{\@startsection{subsection}{2}{\z@}%
                                     {-3.25ex\@plus -1ex \@minus -.2ex}%
                                     {1.5ex \@plus .2ex}%
                                     {\normalfont\normalsize\bfseries}}
\renewcommand\subsubsection{\@startsection{subsubsection}{3}{\z@}%
                                     {-3.25ex\@plus -1ex \@minus -.2ex}%
                                     {1.5ex \@plus .2ex}%
                                     {\normalfont\normalsize\bfseries}}
\renewcommand\su@LARGE{\Large}

}
\ProcessOptions\relax

\def\@makechapterhead#1{%
  %\vspace*{30\p@}%
  {\parindent \z@ \raggedright \normalfont
    \@hangfrom{%
    \ifnum \c@secnumdepth >\m@ne
        \su@LARGE\bfseries%
         %\ifx\@chapapp\empty
         \setbox0=\hbox{\@chapapp\unskip}%
         \ifdim\wd0=0pt
           \relax
         \else
           \@chapapp\space
         \fi
         \thechapter.\hbox to 0.3em {}  % Trimmed here
        \nobreak
    \fi
    }%
    {\interlinepenalty\@M
    \su@LARGE \bfseries #1\par\nobreak
    }
    \vskip 15\p@
    %\thispagestyle{empty}
  }}



%microtype, flafter
% использовать Times New Roman (checked)

%Например, команда \enlargethispage{2\baselineskip} позволит текущей странице стать длиннее (выше) на две строчки. Вариант команды «со звёздочкой», \enlargethispage*{длина}, попытается сжать страницу насколько это возможно.


%\RequirePackage{listings} % Не работает с русскими комментариями.


%Основные требования для макетов в редакторе Тех
%Поля: верхнее – 1,8 см, нижнее – 2,8, левое и правое – 2,7
%Риасстояние от края страницы до колонтитула – 2,1 см

%\def\normalsize{\fontsize{15}{18}\selectfont{}}

%\renewcommand{\publishername}{Иркутский государственный технический университет}
%\renewcommand{\locationname}{Иркутск}
\def\baselinestretch{1.0}


\theoremseparator{.}

\newenvironment{mygroup}{}{}

\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{3}
% - ISDCT SB RAS Dissertation package -----
\renewcommand{\baselinestretch}{1.0}

% adjustenment of the title sizes.
\renewcommand\cftpartaftersnum{.}
\renewcommand\cftchapaftersnum{.}
\renewcommand\cftsecaftersnum{.}
\renewcommand\cftsubsecaftersnum{.}
\renewcommand\cftsubsubsecaftersnum{.}
%% %\renewcommand\ctfchapfont{\large\bf}
\renewcommand\cftpartnumwidth{3ex}
\renewcommand\cftchapnumwidth{3ex}
\renewcommand\cftsecnumwidth{4ex}
\renewcommand\cftsubsecnumwidth{6ex}
\renewcommand\cftsubsubsecnumwidth{7ex}


\sectiondot{section}
\sectiondot{subsection}
\sectiondot{subsubsection}
\sectiondot{subsubsubsection}

\def\@schapter#1{\if@twocolumn
                   \@topnewpage[\@makeschapterhead{#1}]%
                 \else
                   \@makeschapterhead{#1}%
                   \@afterheading
                 \fi
                 \addcontentsline{toc}{chapter}{#1}% Added here
    %\thispagestyle{plain}%
        \@mkboth{%
           \MakeUppercase{#1}}{\MakeUppercase{#1}}%
}

\renewcommand\bibsection{%
\chapter*{\bibname}%
\@mkboth{\MakeUppercase{\bibname}}{\MakeUppercase{\bibname}}%
}%

% This is for the following table of contents printing
\def\@sschapter#1{\if@twocolumn
                   \@topnewpage[\@makeschapterhead{#1}]%
                 \else
                   \@makeschapterhead{#1}%
                   \@afterheading
                 \fi
}

\def\@makeschapterhead#1{%
  %\vspace*{30\p@}%
  {\parindent \z@ \raggedright
    \normalfont
    \interlinepenalty\@M
    \su@LARGE \bfseries  #1\par\nobreak
    \vskip 15\p@ %% Here
  }}


\hypersetup{
    bookmarks=true,         % show bookmarks bar?
    unicode=true,          % non-Latin characters in Acrobat’s bookmarks
    pdftoolbar=true,        % show Acrobat’s toolbar?
    pdfmenubar=true,        % show Acrobat’s menu?
    pdffitwindow=false,     % window fit to page when opened
    pdfstartview={FitH},    % fits the width of the page to the window
    pdftitle={Irkutsk State University Work},    % title
    pdfauthor={Some Outstanding ISU.RU Professor},     % author
    pdfsubject={The Subject},   % subject of the document
    pdfcreator={LaTeX},   % creator of the document
    pdfproducer={LaTeX}, % producer of the document
    pdfkeywords={Irkutsk State University}, % list of keywords
    pdfnewwindow=true,      % links in new window
    colorlinks=true,       % false: boxed links; true: colored links
    linkcolor=black, %[rgb]{0 0.4 0.1},          % color of internal links
    citecolor=black, %blue,        % color of links to bibliography
    filecolor=black,      % color of file links
    urlcolor=black % [rgb]{0.3 0.0 0.3}           % color of external links
}

\setcounter{tocdepth}{1}  % Точность представления содержания

\DeclareCaptionLabelSeparator{dotnewline}{.\\}
\DeclareCaptionFormat{rightcenter}{\parbox{\linewidth}{{\raggedleft #1#2}\par {\centering #3}}}

%\renewcommand\@tempdima{60px}

\AtBeginDocument{
\pagenumbering{arabic}
\captionsetup[figure]{labelformat=simple,labelsep=period}
\captionsetup[table]{format=rightcenter,labelsep=newline,singlelinecheck=off}
%\captionsetup[table]{format=plain,labelsep=newline,singlelinecheck=off,justification=Centering} %%%% THIS IS just CENTERED
\renewcommand{\chaptermark}[1]{\markboth{\MakeUppercase{\thechapter.\ #1}}{}}
\renewcommand{\sectionmark}[1]{\markright{\MakeUppercase{\thesection.\ #1}}{}}
\renewcommand\tableofcontents{%
    \if@twocolumn
      \@restonecoltrue\onecolumn
    \else
      \@restonecolfalse
    \fi
    \@sschapter{\contentsname% Here the changes are
        \@mkboth{%
           \MakeUppercase\contentsname}{\MakeUppercase\contentsname}%
    \thispagestyle{plain}%
    }%
    \@starttoc{toc}%
    \if@restonecol\twocolumn\fi
    }
\let\chaptername=\chapter@su@name
}

\isu@defgeom{}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "dis"
%%% End:
